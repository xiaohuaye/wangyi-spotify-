<!DOCTYPE html>
<html lang="cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>网易云音乐手机端（spotify风格）</title>
  <link rel="stylesheet" href="./css/index.css">
  <script src="//at.alicdn.com/t/font_997722_pf18f3utoa.js"></script>
  <script>
      var pageWidth = window.innerWidth;
      document.write('<style>html{font-size:'+pageWidth+'px;}</style>')
  </script>
</head>
<body>
  <section class="home active">
    <div class="recommend">
      <h1>特别推荐</h1>
      <ul class="recommend-wrapper">
        <li class="site-songlist" data-songListId="zl7b2c36315c4a683c83b17f8e595663d0540d540d5355">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163575057615.webp" alt="">
          <span>第61届格莱美奖提名名单</span>
        </li>
        <li class="site-songlist" data-songListId="zl9cb84e9197f365484e0e753597f3">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163662814383.webp" alt="">
          <span>鲸云音效与电音</span>
        </li>
        <li class="site-songlist" data-songListId="zl90a34e9b8d855e26611f768482f165876b4c66f2">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163731947006.webp" alt="">
          <span>那些超带感的英文歌曲</span>
        </li>
        <li class="site-songlist" data-songListId="zl5b899759768465e58bed6b4c">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163756018423.webp" alt="">
          <span>安静的日语歌</span>
        </li>
        <li class="site-songlist" data-songListId="zl57307403774096468ba15212">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163763955468.webp" alt="">
          <span>地球着陆计划</span>
        </li>
        <li class="site-songlist" data-songListId="zl572859166f026cca">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163769386329.jpg" alt="">
          <span>在外漂泊</span>
        </li>
      </ul>
    </div>
    <div class="lastestSong">
      <h1>最新歌曲</h1>
      <div class="lastestSong-wrapper">

      </div>
    </div>
  </section>


  <section class="search">
    <h1>Search</h1>
    <form>
      <span></span><svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-search"></use>
      </svg></span>
      <input type="text" placeholder="请输入艺术家，歌名">
    </form>
    <ul id="search-result"></ul>
  </section>
  <section class="songList">
    <div class="topNarBar">
      <span class="active">歌单</span>
      <span>艺术家</span>
      <span>专辑</span>
    </div>
  </section>
  <section class="songlist-detail">
    <nav>
      <span>返回</span>
      <span>喜欢</span>
    </nav>
    <img src="http://pjxo7l586.bkt.clouddn.com/109951163756018423.webp" alt="">
    <div class="title"></div>
    <ul></ul>
  </section>
  <footer>
    <div class="player">
      <span><svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-xihuan"></use>
      </svg></span>
      <a href="./player.html" class="player-index">--.--</a>
      <span><svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-bofang2"></use>
      </svg></span>
    </div>
    <div class="menu">
      <div class="site-home active">
          <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-home"></use>
          </svg>
        <span>主页</span>
      </div>
      <div class="site-search">
          <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-search"></use>
          </svg>
          <span>搜索</span>
      </div>
      <div class="site-library">
          <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-baseline-library_mus"></use>
          </svg>
          <span>音乐库</span>
      </div>
    </div>
  </footer>
</body>
<script src="../vendor/jquery.min.js"></script>
<script src="../vendor/av-min.js"></script>
<script src="./js/av-init.js"></script>

<script>
  $('.menu>div').on('click',(e)=>{
    $(e.currentTarget).addClass('active').siblings().removeClass('active')
    let index = $('.menu>div').index(e.currentTarget)
    let page = $('section')
    $(page[index]).addClass('active').siblings().removeClass('active')
  })

  $('.songList>.topNarBar>span').on('click',e=>{
    $(e.currentTarget).addClass('active').siblings().removeClass('active')
  })
//全局的歌单被点击时，触发
  $('body').on('click','.site-songlist', e=>{
    $('section').removeClass('active')
    let section = $('section')
    $(section[3]).addClass('active')
    let listId = e.currentTarget.attributes[1].nodeValue
    if(listId){
      let query = new AV.Query(listId);
      query.find().then((songlists)=> {
        let lidom =  songlists.map(songlist=>{
          if(songlist.attributes.url){
            let name = songlist.attributes.name.split('.mp')
            let $li = $('<li class="site-song"></li>').attr(
              {'data-song-id': songlist.id,
              'data-songlistName': listId
          })
            let $span1 = $('<span></span>').text(name[0])
            let $span2 = $('<span></span>').text(songlist.attributes.singer)
            $($li).append($span1).append($span2)
            return $li
          }else if(songlist.attributes.listName){
            let h1 = $('<h1></h1>').text(songlist.attributes.listName)
            $('.title').empty().append(h1)
          }
        })
        $('.songlist-detail>ul').empty()
        lidom.map(song=>{
          $('.songlist-detail>ul').append(song)
        })
      },
      (error)=>{console.log(error)})
    }
    // $('.songlist-detail').on('scroll',()=>{
    // let offset = $('.songlist-detail .title').offset()
    // console.log(offset)
  // })
  })
  //全局的歌被点击时触发
  $('body').on('click','.site-song', e=>{
    let hash = {
      'songId' : e.currentTarget.attributes[1].value,
      'className' : e.currentTarget.attributes[2].value
    }
    let url = `./player.html?className=${hash['className']}&&songId=${hash['songId']}`
    window.location.href = url
  })
  
  //搜索
  $('.search form').on('submit',(e)=>{
    e.preventDefault()
    $('#search-result').empty()
    let value = $('.search input')[0].value
    hash = ['name','singer']
    for(i=0;i<hash.length;i++){
      search(hash[i],value)
    }
  }
)
function search(className,value){
  var query = new AV.Query('AllSongLists');
  query.find().then(
      (songlists)=>{  //歌单列表
        songlists.map((songlist)=>{  //每一个歌单
          let ObjectName = songlist.attributes.ObjectName
          let query1 = new AV.Query(ObjectName) //查找每个歌单
            query1.contains(className,value);
            return query1.find().then( //在歌单里面查找对应的歌
            songs=>{
              if(songs.length !== 0){ //如果找到
                songs.map(song=>{
                  console.log(song)
                  let name = song.attributes.name.split('.mp') //name[0]就是歌名
                  let $li = $('<li class="site-song"></li>').attr(
                    {
                    'data-song-id': song.id,
                    'data-songlistName': song.attributes.listName
                    })
                    let $span1 = $('<span></span>').text(name[0])
                    let $span2 = $('<span></span>').text(song.attributes.singer)
                    $($li).append($span1).append($span2)
                    $('#search-result').append($li)
                })
              }
            }
          )
        
      })
    })
}
</script>
</html>