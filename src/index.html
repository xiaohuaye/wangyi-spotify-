<!DOCTYPE html>
<html lang="cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>网易云音乐手机端（spotify风格）</title>
  <link rel="stylesheet" href="./css/index.css">
  <script src="//at.alicdn.com/t/font_997722_908aa94hq19.js"></script>
  <script>
      var pageWidth = window.innerWidth;
      document.write('<style>html{font-size:'+pageWidth+'px;}</style>')
  </script>
</head>
<body>
  <section class="home active">
    <div class="recommend">
      <h1>特别推荐</h1>
      <ul class="recommend-wrapper">
        <li class="site-songlist" data-songListId="zl7b2c36315c4a683c83b17f8e595663d0540d540d5355">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163575057615.webp" alt="">
          <span>第61届格莱美奖提名名单</span>
        </li>
        <li class="site-songlist" data-songListId="zl9cb84e9197f365484e0e753597f3">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163662814383.webp" alt="">
          <span>鲸云音效与电音</span>
        </li>
        <li class="site-songlist" data-songListId="zl90a34e9b8d855e26611f768482f165876b4c66f2">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163731947006.webp" alt="">
          <span>那些超带感的英文歌曲</span>
        </li>
        <li class="site-songlist" data-songListId="zl5b899759768465e58bed6b4c">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163756018423.webp" alt="">
          <span>安静的日语歌</span>
        </li>
        <li class="site-songlist" data-songListId="zl57307403774096468ba15212">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163763955468.webp" alt="">
          <span>地球着陆计划</span>
        </li>
        <li class="site-songlist" data-songListId="zl572859166f026cca">
          <img src="http://pjxo7l586.bkt.clouddn.com/109951163769386329.jpg" alt="">
          <span>在外漂泊</span>
        </li>
      </ul>
    </div>
    <div class="lastestSong">
      <h1 class="title-new"></h1>
      <div class="lastestSong-wrapper">
        <ul></ul>
      </div>
    </div>
  </section>


  <section class="search">
    <h1>Search</h1>
    <form>
      <span></span><svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-search"></use>
      </svg></span>
      <input type="text" placeholder="请输入艺术家，歌名">
    </form>
    <div class="class-recommend">
      <h2>浏览全部</h2>
      <ul>
        <li class="site-songlist" data-songListId="zl53e45178" style="background: linear-gradient(135deg, rgba(14,59,50,1) 0%, rgba(52,153,84,1) 100%);">
          <span>古典</span>
        </li>
        <li class="site-songlist" data-songListId="zl4f24611f" style="background: linear-gradient(135deg, rgba(92,5,51,1) 0%, rgba(184,106,70,1) 100%);">
          <span>伤感</span>
        </li>
        <li class="site-songlist" data-songListId="zl53e45178" style="background: linear-gradient(135deg, rgba(5,20,92,1) 0%, rgba(105,116,219,1) 100%);">
          <span>流行乐</span>
        </li>
        <li class="site-songlist" data-songListId="zl75355b50821e66f2" style="background: linear-gradient(135deg, rgba(128,36,120,1) 0%, rgba(215,104,217,1) 100%);">
            <span>电子舞曲</span>
        </li>


      </ul>
    </div>
    <ul id="search-result"></ul>
  </section>
  <section class="songList">
    <div class="topNarBar">
      <span class="topNarBar-art active">艺术家</span>
      <span class="topNarBar-albums">专辑</span>
      <span class="topNarBar-likeSong">喜欢的歌</span>
    </div>
    <div class="art-page active">
      <ul>
        <li class="site-songlist" data-songListId="zl67974fca6770">
          <img src="http://pldcmrsc6.bkt.clouddn.com/20161209164303152140.jpg" alt="">
          <span>林俊杰</span>
        </li>
        <li class="site-songlist" data-songListId="zl859b4e4b8c26">
          <img src="http://pldcmrsc6.bkt.clouddn.com/4140d2c8-2f68-4825-8718-fdbc80282693.jpg" alt="">
          <span>薛之谦</span>
        </li>
        <li class="site-songlist" data-songListId="zl521d97f3">
          <img src="http://pldcmrsc6.bkt.clouddn.com/8c1a694ba72143a7a1199c09469f4f2f.jpeg" alt="">
          <span>初音</span>
        </li>
        <li class="site-songlist" data-songListId="zl5b5971d559ff">
          <img src="http://pldcmrsc6.bkt.clouddn.com/T001R300x300M000001pWERg3vFgg8.jpg" alt="">
          <span>孙燕姿</span>
        </li>
        <li class="site-songlist" data-songListId="zl90937d2b68cb">
          <img src="http://pldcmrsc6.bkt.clouddn.com/www.nwlg.net_2014531815.jpg" alt="">
          <span>邓紫棋</span>
        </li>
      </ul>
    </div>
    <div class="albums-page"><ul></ul></div>
    <div class="likeSong-page active"><ul></ul></div>
  </section>
  <section class="songlist-detail">
    <nav>
      <span class="back">
        <svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-tubiaozhizuomoban-"></use>
      </svg></span>
      <span>
        <svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-help"></use>
      </svg>
    </span>
    </nav>
    <img src="http://pjxo7l586.bkt.clouddn.com/109951163756018423.webp" alt="">
    <div class="title"></div>
    <ul></ul>
  </section>
  <footer>
    <div class="player">
      <span id="like" class="like-selec">
        <svg class="icon dislike active" aria-hidden="true">
          <use xlink:href="#icon-xihuan"></use>
        </svg>
        <svg class="icon like" aria-hidden="true">
            <use xlink:href="#icon-xihuan1"></use>
        </svg>
      </span>
      <audio src=""></audio>
      <a href="#" class="player-index"><span></span></a>
      <span id="footer-play" class="footer-play">
        <svg class="icon start active" aria-hidden="true">
          <use xlink:href="#icon-bofang2"></use>
        </svg>
        <svg class="icon pause" aria-hidden="true">
          <use xlink:href="#icon-zantingtingzhi"></use>
        </svg>
    </span>
    </div>
    <div class="menu">
      <div class="site-home active">
          <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-home"></use>
          </svg>
        <span>主页</span>
      </div>
      <div class="site-search">
          <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-search"></use>
          </svg>
          <span>搜索</span>
      </div>
      <div class="site-library">
          <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-baseline-library_mus"></use>
          </svg>
          <span>音乐库</span>
      </div>
    </div>
  </footer>
</body>
<script src="../vendor/jquery.min.js"></script>
<script src="../vendor/av-min.js"></script>
<script src="./js/av-init.js"></script>

<script>
  // $('footer>.player>a').on('click',()=>{
  //   e.preventDefault()
  //   localStorage.getItem('wangyimusic')
  //   let url = `./player.html?className=${hash['className']}&&songId=${hash['songId']}`
  //   console.log(url)
  //   window.location.href = url
  // })


  $('body').on('touchstart','.site-song',handleStart)
  $('body').on('touchend','.site-song',handleEnd)
  function handleStart(e){
    $(e.currentTarget).addClass('active').siblings().removeClass('active')
  }
  function handleEnd(e){
    $(e.currentTarget).removeClass('active')      
  }


  $('.songlist-detail').on('scroll',(e)=>{
    topSonglistDetailChange = $('.songlist-detail img').offset()
    if(topSonglistDetail.top >= (topSonglistDetailChange.top + 10)){
      $('.songlist-detail nav').css('background-color','#191911')
    }
    else{
      $('.songlist-detail nav').css('background-color','rgba(0,0,0,0.2)')
    }
  })

  $('.songlist-detail>nav>.back').on("click",(e)=>{
    $('section').removeClass('active')
    let section = $('section')
    $(section[pageNumber]).addClass('active')
  })
  //从本地获取上一次歌曲的信息
  let hashlocalStorage = JSON.parse(localStorage.getItem('wangyimusic') || '')
  let query = new AV.Query(hashlocalStorage['className'])
  query.get(hashlocalStorage['songId']).then(
    song=>{
      let name = song.attributes.name.split('.mp')
      let singer = song.attributes.singer
      let url = song.attributes.url
      let Aurl = `./player.html?className=${hashlocalStorage['className']}&&songId=${hashlocalStorage['songId']}`
      $('.player-index>span').text(`${name[0]}--${singer}`)
      $('.player audio').attr('src',url)
      $('.player a').attr('href',Aurl)
    }
  ).then(()=>{
    let text = $('.player-index>span').text()
    if(text){
      let hashlocalStorage = JSON.parse(localStorage.getItem('wangyimusic'))
      let url = $('.player audio').attr('src')
      let query1 = new AV.Query('Like')
      query1.equalTo('url', url);
      query1.find().then(song=>{
        if(song.length !== 0){
          $('.like-selec>.like').addClass('active').siblings().removeClass('active')
        }else{
          $('.like-selec>.dislike').addClass('active').siblings().removeClass('active')
        }
      })
    }  
  }
)
  
  
  let query2 = new AV.Query('zl65b06b4c535566f2');
      query2.find().then((songlists)=> {
        let lidom = songlists.map(songlist=>{
          if(songlist.attributes.url){
            let name = songlist.attributes.name.split('.mp')
            let $li = $('<li class="site-song"></li>').attr(
              {'data-song-id': songlist.id,
              'data-songlistName': 'zl65b06b4c535566f2'
          })
            let $img = $(`<img src=${songlist.attributes.imgURL}></img>`)
            let $span1 = $('<span></span>').text(name[0])
            let $span2 = $('<span></span>').text(songlist.attributes.singer)
            $($li).append($img).append($span1).append($span2)
            return $li
          }else if(songlist.attributes.listName){
            let h1 = $('<h1></h1>').text(songlist.attributes.listName)
            $('.title-new').empty().append(h1)
          }
        })
        $('.lastestSong-wrapper>ul').empty()
        lidom.map(song=>{
          $('.lastestSong-wrapper>ul').append(song)
        })
      },
      (error)=>{console.log(error)
    })

  $('.menu>div').on('click',(e)=>{
    $(e.currentTarget).addClass('active').siblings().removeClass('active')
    let index = $('.menu>div').index(e.currentTarget)
    let page = $('section')
    $(page[index]).addClass('active').siblings().removeClass('active')
    $('.class-recommend').removeClass('hidden')
    $('#search-result').empty()
  })

  $('.songList>.topNarBar>span').on('click',e=>{
    $(e.currentTarget).addClass('active').siblings().removeClass('active')
  })
  let taggle = false
  let time
  $('#footer-play').on('click',()=>{
    let aWidth = $('.player-index').width()
    let sWidth = $('.player-index>span').width()
    if($('.player audio').attr('src')){
      if(time){
        clearInterval(time)
        $('.player-index>span').css('display',`none`)
        setTimeout(()=>{
                $('.player-index>span').css('display','inline')
                $('.player-index>span').css('margin-left',`0px`)
              },100)
      }
    let audio = $('audio')
      if(!taggle){
        audio[0].play()
        taggle = true
        $('#footer-play>.pause').addClass('active').siblings().removeClass('active')
        if(aWidth<sWidth){
          let n = 0
          time = setInterval(() => {
            $('.player-index>span').css('margin-left',`${n}px`)
            if((-n/2)>sWidth){
              $('.player-index>span').css('display','none')
              n = sWidth
              setTimeout(()=>{
                $('.player-index>span').css('display','inline')
              },100)
            }else{n = n - 3}
          },100) 
        }
      }else{
        audio[0].pause()
        taggle = false
        $('#footer-play>.start').addClass('active').siblings().removeClass('active')
      }
    }
  })
//全局的歌单被点击时，触发
var pageNumber
var topSonglistDetail
  $('body').on('click','.site-songlist', e=>{
    for(let i = 0;i<3;i++){
      let string = $('section')[i].className.split(' ')
      if(string[1] === "active"){
        pageNumber = i
        break
      }
    }
    $('section').removeClass('active')
    let section = $('section')
    $(section[3]).addClass('active')
    topSonglistDetail = $('.songlist-detail img').offset()
    let listId = e.currentTarget.attributes[1].nodeValue
    if(listId){
      let query = new AV.Query(listId);
      query.find().then((songlists)=> {
        let lidom =  songlists.map(songlist=>{
          if(songlist.attributes.url){
            let name = songlist.attributes.name.split('.mp')
            let $li = $('<li class="site-song"></li>').attr(
              {'data-song-id': songlist.id,
              'data-songlistName': listId
          })
            let $span1 = $('<span></span>').text(name[0])
            let $span2 = $('<span></span>').text(songlist.attributes.singer)
            $($li).append($span1).append($span2)
            return $li
          }else if(songlist.attributes.listName){
            let h1 = $('<h1></h1>').text(songlist.attributes.listName)
            $('.title').empty().append(h1)
          }
        })
        $('.songlist-detail>ul').empty()
        lidom.map(song=>{
          $('.songlist-detail>ul').append(song)
        })
      },
      (error)=>{console.log(error)})
    }
  })
  //全局的歌被点击时触发
  $('body').on('click','.site-song', e=>{
    let hash = {
      'songId' : e.currentTarget.attributes[1].value,
      'className' : e.currentTarget.attributes[2].value
    }
    localStorage.setItem('wangyimusic',JSON.stringify(hash))
    let url = `./player.html?className=${hash['className']}&&songId=${hash['songId']}`
    console.log(url)
    window.location.href = url
  })
  
  //搜索
  $('.search form').on('submit',(e)=>{
    e.preventDefault()
    $('.class-recommend').addClass('hidden')
    $('#search-result').empty()
    let value = $('.search input')[0].value
    hash = ['name','singer']
    for(i=0;i<hash.length;i++){
      search(hash[i],value)
    }
  }
)
$('.songList>.topNarBar>span').on('click',(e)=>{
  let index = $(e.currentTarget).index()
  let div = $('.songList>div')[index+1]
  $(div).addClass('active').siblings().removeClass('active')
  if(index === 2){
    render()
  }
})

$('#like').on('click',()=>{
  let text = $('.player-index>span').text()
  if(text){
    let hashlocalStorage = JSON.parse(localStorage.getItem('wangyimusic'))
    let url = $('.player audio').attr('src')
    let query1 = new AV.Query('Like')
    query1.equalTo('url', url);
    query1.find().then(song=>{
      if(song.length === 0){
        let query = new AV.Query(hashlocalStorage['className']);
          query.get(hashlocalStorage['songId']).then( (song)=> {
            let Like = AV.Object.extend('Like');
            let like = new Like();
            like.set('listName','like');
            like.set('name',song.attributes.name)
            like.set('singer',song.attributes.singer)
            like.set('url',song.attributes.url)
            like.save().then(song=> {
              $('.like-selec>.like').addClass('active').siblings().removeClass('active')
              render()
            }, (error)=> {
              console.error(error);
            });
        }, (error)=> {
          console.log(error)
        });
      }else{
        let todo = AV.Object.createWithoutData('Like', song[0].id);
        todo.destroy().then((success)=> {
          $('.like-selec>.dislike').addClass('active').siblings().removeClass('active')
          console.log(success)
          render()
        }, (error)=> {
          console.log(error)
        });
      }
    },error=>{
      console.log(error)
    }) 
  }
})

function render(){
  let query5 = new AV.Query('Like');
  query5.find().then((songlists)=> {
    let lidom =  songlists.map(songlist=>{
      if(songlist.attributes.url){
        let name = songlist.attributes.name.split('.mp')
        let $li = $('<li class="site-song"></li>').attr(
          {'data-song-id': songlist.id,
          'data-songlistName': 'Like'
      })
        let $span1 = $('<span></span>').text(name[0])
        let $span2 = $('<span></span>').text(songlist.attributes.singer)
        $($li).append($span1).append($span2)
        return $li
      }
    })
  $('.likeSong-page>ul').empty()
  lidom.map(song=>{
    $('.likeSong-page>ul').append(song)
  })
},
(error)=>{console.log(error)})
}



function search(className,value){
  var query = new AV.Query('AllSongLists');
  query.find().then(
      (songlists)=>{  //歌单列表
        songlists.map((songlist)=>{  //每一个歌单
          let ObjectName = songlist.attributes.ObjectName
          let query1 = new AV.Query(ObjectName) //查找每个歌单
            query1.contains(className,value);
            return query1.find().then( //在歌单里面查找对应的歌
            songs=>{
              if(songs.length !== 0){ //如果找到
                songs.map(song=>{
                  console.log(song)
                  let name = song.attributes.name.split('.mp') //name[0]就是歌名
                  let $li = $('<li class="site-song"></li>').attr(
                    {
                    'data-song-id': song.id,
                    'data-songlistName': song.attributes.listName
                    })
                    let $span1 = $('<span></span>').text(name[0])
                    let $span2 = $('<span></span>').text(song.attributes.singer)
                    $($li).append($span1).append($span2)
                    $('#search-result').append($li)
                })
              }
            }
          )
        
      })
    })
}
</script>
</html>